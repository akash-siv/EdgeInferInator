#include <WiFi.h>
#include <ArduinoHA.h>
#include <Tutorial_Continuous_motion_recognition_R2_inferencing.h>
#include <HTTPClient.h>

#define FREQUENCY_HZ        EI_CLASSIFIER_FREQUENCY
#define INTERVAL_MS         (1000 / (FREQUENCY_HZ + 1))
#define BROKER_ADDR         IPAddress(192,168,176,231)
#define WIFI_SSID           "Nothing_Phone_(2a)_1131"
#define WIFI_PASSWORD       "ykdcig35iiaj5jno"
#define HA_USER             "hacktrent"
#define HA_PASS             "hacktrent"
#define NUM_FEATURE_SETS    6
#define FEATURE_LENGTH      EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE

const char* serverName = "https://us-east-1.aws.data.mongodb-api.com/app/data-zvqsdey/endpoint/data/v1/action/insertOne";
const char* apiKey = "IwI3jHXfhOogBqwtV51BGXUaM1pU7TrbZhqaouMe4HqZqqccEYfbtgGj8AXkJMRN";

WiFiClient client;
HADevice device;
HAMqtt mqtt(client, device);

HABinarySensor class1("circle");
HABinarySensor class2("four");
HABinarySensor class3("go");
HABinarySensor class4("rotate");
HABinarySensor class5("waving");

static unsigned long last_interval_ms = 0;

const float feature_sets[NUM_FEATURE_SETS][FEATURE_LENGTH] = {
    {         
      6.6100, -3.7000, 6.4100, -4.5200, 6.2200, -5.1600, 6.3800, -5.7700, 6.6100, -6.0500, 6.9600, -5.8800, 7.1400, -5.5000, 7.2000, -4.7500, 7.2100, -4.1700, 7.2000, -3.9600, 7.1200, -3.7000, 7.1000, -3.6600, 7.2000, -3.6500, 7.2700, -3.6300, 7.2800, -3.7300, 7.4100, -3.8000, 7.4700, -3.6700, 7.4800, -3.5900, 7.5300, -3.5000, 7.4200, -3.6900, 7.4400, -3.3400, 7.4100, -2.9500, 7.3600, -2.9600, 7.2700, -2.7000, 7.2600, -2.5100, 7.0600, -2.7700, 6.9700, -2.7800, 6.9200, -2.7900, 6.8900, -2.8200, 6.9800, -3.1200, 7.0700, -2.9500, 7.1200, -2.8000, 7.1500, -2.5400, 7.1000, -2.3400, 7.0900, -2.1700, 7.0000, -2.2800, 6.7900, -2.2500, 6.6300, -2.2200, 6.5900, -2.1500, 6.6200, -2.2200, 6.8200, -2.2700, 6.9900, -2.3300, 6.9500, -2.3100, 7.0200, -2.2900, 7.1300, -1.8700, 7.2000, -1.6100, 7.3100, -1.2400, 7.2400, -0.8500, 7.4300, -0.7400, 7.5400, -0.7100, 7.8200, -0.7500, 8.0600, -0.6500, 8.1300, -0.7700, 8.4100, -1.0400, 8.5600, -1.2200, 8.8400, -1.4800, 9.2200, -1.6700, 9.5400, -1.9600, 9.6800, -2.0500, 9.8800, -2.4000, 10.1800, -2.9900, 10.3800, -3.3400, 10.4100, -3.4600, 10.5600, -3.5100, 10.6500, -3.6700, 10.4400, -3.6900, 10.1600, -3.7300, 9.9100, -4.0900, 9.6000, -4.7700, 9.4700, -5.3700, 9.3700, -6.0500, 9.2700, -6.5200, 9.0900, -6.9600, 8.9400, -7.3900, 8.6300, -7.4300, 8.3600, -7.5700, 8.0000, -7.5200, 7.5400, -7.6100, 7.1000, -7.6700, 6.6700, -7.5500, 6.4700, -7.4800, 6.2400, -7.1500, 5.9100, -6.8600, 5.4600, -6.3800, 5.1300, -5.8100, 4.7800, -5.5400, 4.5500, -4.9700, 4.2800, -4.4100, 4.0100, -3.8300, 3.8500, -3.2000, 3.8600, -2.6700, 3.7800, -2.2100, 3.6500, -1.7000, 3.5300, -1.3200, 3.4200, -0.9200, 3.3900, -0.6000, 3.3900, -0.5400, 3.3400, -0.1100, 3.4500, 0.3400, 3.4000, 0.8300, 3.3000, 1.2900, 3.1000, 1.6800, 2.9900, 2.0300, 3.2600, 2.2400, 3.2700, 2.6500, 3.2800, 2.9300, 3.4200, 3.5100, 3.7000, 4.0600, 3.9200, 4.7800, 4.2800, 5.3400, 4.6800, 5.7100, 5.1000, 6.0000, 5.1600, 6.0600, 5.2800, 5.8700, 5.5200, 5.6500, 5.7800, 5.7100, 6.2700, 5.6100, 6.9800, 5.2200, 7.4500, 5.2600, 7.6000, 5.3300, 8.0100, 5.0400, 8.2700, 5.1300, 8.1900, 5.0300, 8.5400, 4.9600, 8.9000, 4.9900, 9.0300, 5.2600, 9.7600, 6.0500, 8.1800, 5.2800, 10.5600, 5.2400, 11.3800, 4.6800, 9.8900, 3.9400, 10.1500, 3.1300, 10.6000, 3.5500, 10.2800, 3.6200, 10.6700, 3.4700, 10.5300, 3.2800, 10.2900, 2.7800, 10.4000, 2.1300, 10.0400, 1.5000, 9.9100, 0.6300, 10.1800, 0.0900, 10.4300, -0.4900, 10.4400, -0.8200, 10.3400, -1.3300, 10.3100, -2.0900, 10.3100, -2.9300, 10.2200, -3.9400, 10.1600, -4.7200, 10.0400, -5.5900, 9.7000, -6.2300, 9.3900, -6.8900, 9.2600, -7.3400, 9.1100, -7.6900, 8.9300, -8.0500, 8.6700, -8.1000, 8.3900, -8.0800, 8.0900, -7.8600, 7.8600, -7.7800, 7.4600, -7.7700, 7.1400, -7.7200, 6.9500, -7.7500, 6.6600, -7.7800, 6.3100, -7.6400, 6.2400, -7.6700, 5.9500, -7.4300, 5.8300, -7.6300, 5.7100, -7.6400, 5.5000, -7.5500, 5.4500, -7.4000, 5.3100, -7.3000, 5.1700, -7.2400, 5.0300, -7.0200, 4.9800, -6.8600, 4.8900, -6.6200, 4.7900, -6.3100, 4.6100, -5.9200, 4.6900, -5.4500, 4.5300, -5.0200, 4.1900, -4.5400, 4.2500, -4.1500, 4.1900, -3.5500, 4.0600, -3.1300, 4.0500, -2.6500, 4.0600, -2.4000, 4.1400, -1.9200, 4.1300, -1.5800, 4.2700, -0.9700, 3.8200, -0.2500, 3.5700, 0.1000, 3.4400, 0.4600, 3.4600, 1.0800, 3.4400, 1.6000, 3.7200, 2.4000, 3.7600, 3.4400, 3.7800, 4.1300, 3.9100, 4.7200, 3.9600, 5.0700, 4.1500, 5.0200, 4.4100, 5.0400, 4.7200, 5.1200
    }, // Circle data
    {         
      1.9700, -14.5900, 2.0700, -14.6100, 2.0200, -14.7500, 1.7700, -14.6400, 1.3900, -14.1400, 1.0900, -13.5800, 0.8500, -13.6200, 0.4200, -13.1200, -0.2000, -12.6500, -0.8400, -11.6900, -1.6200, -9.9500, -2.2600, -8.1000, -2.3800, -6.7900, -2.4600, -5.6200, -2.9100, -4.2300, -3.2900, -2.6000, -3.5200, -0.9900, -3.9200, 0.4000, -4.2800, 2.9800, -4.6800, 5.5800, -4.5800, 6.7300, -4.4700, 7.6200, -4.3300, 8.5700, -4.4400, 9.6700, -4.4800, 10.7700, -4.4400, 12.4400, -4.4500, 14.2400, -4.5900, 16.5300, -4.2400, 18.8500, -4.2500, 20.5500, -4.6100, 21.8100, -4.6900, 21.8700, -4.6200, 21.1100, -4.2600, 20.4500, -3.6200, 19.6300, -2.8800, 18.5500, -2.5300, 17.0700, -2.6300, 15.5700, -2.7600, 14.0800, -3.0800, 12.9000, -3.4100, 11.8600, -3.5600, 10.7300, -3.6700, 9.9100, -3.5600, 8.7200, -3.4400, 7.8100, -3.6900, 7.0600, -3.8900, 6.4500, -3.8600, 5.4200, -3.8900, 4.2500, -3.6600, 2.8700, -3.5600, 1.2800, -3.8300, -0.1600, -4.0100, -2.6400, -4.0300, -6.2900, -3.9000, -8.2100, -3.8200, -9.2900, -3.1800, -10.6600, -2.2100, -11.8000, -1.2200, -12.4100, -0.7000, -12.3500, 0.0100, -13.0600, 0.3900, -13.2700, 0.6000, -13.2100, 0.7900, -14.1100, 0.7900, -14.4900, 0.6200, -14.7800, 0.6800, -14.9200, 0.9300, -15.1500, 0.9900, -15.6600, 1.0900, -15.4400, 0.9500, -15.4000, 0.7100, -15.1600, 0.4500, -14.7100, -0.1000, -13.9200, -0.6000, -12.7700, -1.2800, -11.7300, -1.9700, -9.9700, -2.4900, -8.0800, -2.5500, -6.9200, -3.0300, -5.7400, -3.4600, -4.2800, -3.4100, -2.6900, -3.7500, -1.1200, -4.1500, 0.8700, -4.2800, 3.1200, -4.3900, 5.1200, -4.7700, 7.2000, -4.6400, 8.7500, -4.6900, 9.9400, -5.0300, 11.9100, -5.2700, 14.5900, -4.9800, 17.0900, -4.4600, 18.7800, -4.5100, 20.7900, -4.7500, 21.6100, -4.9200, 21.8400, -5.0200, 21.5000, -4.8400, 21.2000, -4.4000, 20.0300, -3.7500, 18.8500, -3.3800, 17.1700, -3.2300, 15.5700, -3.2600, 14.4000, -3.3700, 13.4500, -4.1300, 12.4400, -4.6300, 11.1300, -4.9600, 10.7400, -5.4700, 8.9900, -5.1600, 7.4200, -5.0100, 6.0400, -5.1600, 4.9500, -5.1100, 3.4700, -5.1100, 1.7500, -5.4600, 0.7200, -5.5100, -0.6800, -5.3800, -2.7700, -4.8900, -5.7700, -4.4300, -9.0300, -4.2000, -11.1000, -3.9900, -12.2800, -3.0200, -14.2000, -1.4500, -15.9400, -0.5900, -16.0500, 0.1100, -16.3900, 0.5800, -16.3100, 0.8500, -16.3700, 1.1500, -16.4500, 1.3600, -16.3600, 1.4300, -16.1600, 1.6800, -15.9400, 1.6100, -15.4200, 1.3600, -14.6200, 1.0100, -13.6100, 0.4900, -12.8100, 0.1500, -11.7100, -0.2200, -10.7500, -0.6900, -10.1300, -1.0900, -9.0300, -1.6200, -7.9700, -2.1600, -6.8800, -2.4900, -5.7100, -2.7100, -4.5000, -2.8900, -3.4700, -3.2300, -1.6600, -3.6800, 0.4800, -3.8300, 2.2900, -4.0500, 3.7800, -4.5600, 5.5500, -4.6600, 7.4700, -5.0500, 8.8900, -5.1900, 10.8100, -4.7400, 13.6300, -4.0000, 15.4100, -3.5800, 16.9600, -3.6200, 18.4400, -3.7800, 19.3000, -4.3700, 19.4000, -4.8200, 19.0900, -4.9100, 18.8500, -4.7200, 18.4400, -4.0400, 17.9800, -3.3500, 17.1500, -2.7100, 16.2400, -2.4100, 15.1500, -2.3900, 14.0000, -2.8000, 13.2100, -3.5800, 12.7700, -4.0900, 11.9800, -4.6500, 11.3100, -4.7600, 9.8100, -4.5800, 7.6700, -4.0800, 6.2200, -4.1000, 4.7800, -4.0200, 3.4800, -4.1400, 2.4000, -3.9800, 1.3700, -3.6400, 0.0600, -3.3800, -1.6400, -3.2700, -2.9800, -3.0000, -5.1800, -2.6500, -8.0400, -2.1700, -10.3300, -1.9000, -11.7700, -1.6900, -13.1000, -0.5400, -14.4400, -0.4400, -15.3000, -0.1000, -15.2600, 0.1500, -15.6000, 0.2900, -15.8600, 0.2800, -15.7800, 0.2300, -15.2800, 0.3100, -15.1500, 0.3100, -14.4800, 0.3400, -13.9900, 0.2100, -13.2800, 0.1800, -12.7700, 0.0200, -12.4700, -0.0700, -12.1000, -0.3800, -11.8200, -0.6700, -11.3300        // ... (continue with modified values)
    
    }, // Four data
    {         
      8.3200, -20.0300, 7.6100, -20.7600, 6.7500, -19.9000, 6.0200, -17.8900, 5.4600, -16.0800, 5.4800, -14.2700, 5.0300, -11.7900, 4.5400, -9.6100, 4.6100, -8.3900, 4.3700, -7.5400, 4.1300, -6.3900, 2.5700, -4.0500, 1.3300, -2.8700, 1.0400, 1.0400, 0.0500, 7.0700, -4.1400, 14.5500, -11.1100, 24.7800, -15.9700, 35.1300, -14.1200, 28.2100, -13.8700, 30.2500, -12.7000, 40.1800, -9.9000, 38.3300, -9.1400, 30.6800, -3.3200, 24.2000, 2.4400, 17.3500, 4.4100, 11.6000, 6.0900, 9.3200, 5.1700, 7.6400, 4.8000, 7.4000, 4.6800, 7.0700, 4.5300, 7.1500, 4.2400, 5.5000, 4.6900, 4.1400, 4.6500, 1.9200, 4.5300, -1.1700, 4.6300, -5.2000, 6.0400, -7.6000, 6.9500, -8.7100, 7.6000, -11.0400, 8.7100, -14.0500, 8.8800, -16.0600, 7.9600, -16.7500, 7.4100, -16.3200, 7.2000, -15.2000, 6.3600, -13.5200, 5.7400, -11.6900, 5.5600, -9.4900, 5.8000, -7.8100, 4.9900, -6.6500, 4.4100, -5.9900, 3.8500, -3.2300, 3.3600, -4.2700, 3.2000, -1.3600, 1.6400, 1.9500, -2.0500, 7.0700, -9.5100, 18.9200, -10.9500, 25.5500, -12.7700, 28.9300, -18.1200, 24.6900, -18.8400, 30.9100, -13.4700, 39.0700, -12.6000, 33.4800, -9.5500, 27.6500, -3.2300, 21.3800, 1.8600, 13.1100, 4.5700, 7.8000, 5.2400, 6.7000, 6.6700, 7.2400, 5.9400, 8.6200, 5.4400, 7.9900, 5.0800, 8.8600, 5.2100, 8.5400, 5.0300, 6.6000, 3.6400, 5.3100, 3.0600, 4.2300, 3.6000, 0.8900, 4.5100, -1.8200, 5.5100, -4.0000, 6.6500, -5.9200, 6.9300, -6.7700, 7.5400, -7.3000, 7.5700, -9.3300, 8.0400, -12.1400, 8.1700, -14.7600, 7.4600, -14.4400, 7.3000, -13.5200, 7.6700, -12.1400, 7.4100, -10.8500, 7.2400, -9.8300, 7.0900, -8.9500, 6.1100, -7.0400, 5.8600, -6.1000, 4.8200, -5.9200, 3.7700, -3.6200, 3.5200, -2.8400, 3.3500, 0.5400, 1.5700, 4.5400, -2.0200, 10.2000, -7.9700, 18.6800, -10.1600, 22.9600, -10.0800, 24.6300, -11.7200, 29.5800, -12.1600, 34.0300, -10.9900, 33.4300, -9.4500, 30.6300, -4.9200, 25.2100, 0.1300, 17.9600, 3.7600, 11.3900, 5.5000, 8.3500, 6.4300, 7.6700, 6.0400, 8.2600, 5.3700, 8.0400, 4.9900, 7.3400, 4.6100, 6.3700, 5.3400, 5.5600, 5.2900, 3.7400, 5.3600, 1.8900, 5.0800, -0.0400, 5.7900, -3.0300, 6.9200, -5.9600, 7.7900, -8.0300, 8.6400, -9.9400, 8.8900, -12.1600, 9.5900, -14.7200, 9.2400, -16.1600, 9.0900, -15.0900, 8.5800, -13.0700, 6.6300, -10.0300, 5.3700, -8.2300, 5.1400, -6.5700, 5.3500, -5.6600, 4.5100, -3.8300, 3.7800, -2.0600, 3.3200, -1.9600, 3.0200, 0.5500, 0.9600, 4.5900, -3.8400, 13.0900, -8.4700, 21.1100, -9.3400, 25.4200, -11.5700, 23.4200, -13.4200, 31.2900, -13.0600, 36.7400, -10.8900, 35.7300, -8.0600, 30.1500, -3.0600, 20.9800, 2.6900, 13.4200, 4.9900, 9.1200, 5.5100, 7.5600, 5.5800, 6.9100, 4.9200, 6.4500, 4.6100, 5.8500, 5.1900, 4.5100, 5.3400, 4.6500, 5.5400, 1.7000, 6.0500, -0.8100, 6.2100, -3.4200, 7.3100, -5.6400, 8.5700, -7.7700, 8.5700, -8.8700, 9.5800, -11.0300, 9.2800, -12.6900, 8.6800, -14.4800, 7.6300, -14.2700, 7.1300, -13.7000, 6.6600, -12.2500, 6.9300, -11.3800, 6.3900, -9.5000, 6.1500, -8.0900, 6.0300, -7.3700, 5.8300, -5.0800, 4.7400, -3.5400, 2.1500, -2.1200, 0.7800, -0.1000, -0.7100, 2.4400, -4.0400, 7.2100, -10.1800, 18.0000, -15.0200, 27.0500, -14.6800, 22.5900, -14.2900, 26.6100, -12.5000, 37.0600, -8.8500, 38.9000, -8.1700, 33.4800, -4.4600, 27.1700, 0.4200, 20.2700, 3.5000, 14.0100, 4.6500, 9.1900, 4.9100, 7.8100, 4.3800, 7.2400, 3.2900, 6.3900, 3.7900, 5.5800, 4.3900, 5.2600, 4.2900, 4.6000, 4.4400, 3.7000, 4.1700, 1.7400, 4.0100, -1.1600, 5.0800, -4.2500, 6.1100, -6.6800, 7.3200, -8.7200, 8.6100, -11.8700, 9.4400, -14.2700
    }, // Go data
    {        
      6.0300, -4.4300, 6.3800, -3.5900, 6.1900, -2.7300, 6.0600, -1.9100, 5.9300, -1.1200, 6.0600, -0.1400, 6.1700, 0.9600, 5.9600, 2.1800, 5.2900, 3.4200, 4.8900, 4.6300, 4.4300, 5.2900, 4.0700, 6.0800, 3.7500, 6.8100, 3.5100, 7.6000, 3.3600, 8.3100, 3.2800, 8.9800, 3.1900, 9.5100, 3.3300, 9.8100, 3.3900, 10.2900, 3.9000, 11.0300, 4.6900, 11.0000, 5.6500, 11.3300, 6.6400, 11.8400, 7.3100, 11.7100, 7.7500, 10.7600, 8.3600, 9.5300, 8.6800, 7.8600, 8.9400, 6.3100, 9.2400, 4.1800, 9.7600, 1.8900, 10.4100, -0.3000, 10.9700, -2.7000, 11.1300, -4.5300, 11.2600, -5.8200, 11.3700, -6.9800, 11.5600, -7.6200, 11.0600, -7.7700, 10.5700, -7.6600, 9.9100, -6.9800, 9.1200, -6.5300, 8.5900, -6.1900, 8.0000, -5.8600, 7.3700, -5.4700, 6.9600, -5.1400, 6.7800, -4.7400, 6.4300, -3.8800, 6.2800, -3.0800, 6.0100, -2.1400, 5.7600, -1.6600, 5.6700, -1.4600, 5.5000, -1.7000, 5.4900, -2.1400, 5.4500, -2.2600, 5.3600, -2.3000, 5.1400, -1.9600, 4.6700, -1.2200, 4.2400, -0.2100, 4.0500, 1.3700, 3.8300, 3.3600, 3.6800, 5.7900, 3.6000, 7.8300, 3.6500, 8.9100, 3.2800, 9.8900, 3.1600, 10.7200, 3.4400, 12.3600, 4.1300, 13.9800, 4.8700, 15.6200, 5.9000, 16.4200, 6.7600, 15.8800, 7.8000, 14.3600, 8.6100, 12.5100, 9.1700, 10.3200, 9.6500, 8.1400, 10.1100, 6.1200, 10.4200, 4.0100, 10.7400, 2.4700, 11.0100, 0.7600, 11.0600, -1.1300, 11.4100, -3.2800, 11.4900, -4.9200, 11.3100, -6.5700, 11.1300, -7.7600, 10.7900, -8.7300, 10.4000, -9.2100, 9.9200, -9.2800, 9.3700, -9.0300, 8.7400, -8.2700, 8.2000, -7.5800, 7.9500, -6.8000, 7.6600, -6.0900, 7.2900, -5.5200, 6.8600, -4.6700, 6.3700, -3.5900, 6.0500, -2.6600, 5.4900, -1.7700, 5.0400, -0.9600, 4.4900, -0.5300, 4.0100, -0.2200, 3.7800, 0.2300, 3.5200, 0.9700, 3.3400, 2.0600, 3.1900, 2.9700, 3.1100, 3.7500, 2.9300, 4.7600, 2.9200, 5.7100, 3.0500, 6.6200, 3.1500, 7.6700, 3.0600, 8.5600, 3.0900, 9.4200, 3.3500, 10.1000, 3.5800, 10.7300, 4.0500, 11.0600, 4.8000, 11.1300, 5.8200, 11.4500, 6.5800, 11.2800, 7.0900, 10.8600, 7.8600, 10.3600, 8.4100, 9.7200, 8.8000, 8.9800, 9.3800, 7.9800, 9.7700, 6.9700, 9.8300, 5.5700, 9.9800, 3.9800, 10.2300, 2.3300, 10.2000, 0.3000, 10.2200, -1.7200, 10.4200, -4.0200, 10.9600, -6.0000, 11.1500, -7.5100, 11.0700, -8.7000, 10.9700, -9.2600, 10.5500, -8.9600, 9.8600, -8.4200, 8.9800, -7.5200, 8.2200, -6.6400, 7.4500, -5.8300, 6.4800, -4.8400, 5.7600, -4.1600, 5.3900, -3.8200, 5.2500, -3.4000, 5.2000, -2.8700, 4.9200, -2.2900, 4.7400, -1.8600, 4.7100, -1.5700, 4.7500, -1.5700, 4.5100, -1.4100, 4.4100, -1.1400, 4.2200, -0.2700, 3.8500, 1.1700, 3.3900, 2.4800, 2.9700, 3.8500, 2.7600, 4.8600, 2.7100, 5.6000, 2.9400, 6.6800, 3.1100, 7.8300, 3.3900, 8.9900, 3.7000, 9.6800, 3.9100, 10.2600, 4.1000, 10.9000, 4.6700, 11.4400, 5.4600, 11.8200, 6.6800, 11.8500, 7.7500, 11.7600, 8.8400, 11.3100, 9.4700, 10.3600, 9.9600, 8.9100, 10.3100, 7.6800, 10.4600, 5.9200, 10.3200, 4.3800, 10.1600, 2.7000, 10.1500, 0.8400, 9.9700, -1.0500, 10.3300, -3.1100, 10.5200, -4.9900, 10.7500, -6.2500, 10.9800, -6.7600, 10.8300, -7.1100, 10.4600, -7.2500, 9.9900, -7.1900, 9.4100, -6.8600, 8.8900, -6.6100, 8.3100, -6.2200, 7.7300, -5.8800, 7.2300, -5.3800, 6.7400, -5.0100, 6.2800, -4.5200, 5.8900, -4.1400, 5.4700, -3.3700, 5.3000, -2.4700, 5.0700, -1.4800, 4.6300, -0.7100, 4.2700, -0.1700, 4.2900, 0.3100, 4.2400, 0.6600, 4.2100, 1.0700, 3.9800, 1.7000, 3.6500, 2.4000, 3.3500, 3.3300, 3.0000, 4.5300, 2.8500, 5.6600
    }, // Rotate data
    {         
      9.2700, -5.4800, 8.5500, -4.6000, 7.8100, -3.4000, 7.1000, -2.4900, 6.3200, -1.4700, 5.4200, -0.4400, 4.7700, 0.8000, 4.0100, 1.9800, 3.4000, 3.1400, 3.0500, 4.1700, 3.1900, 5.7100, 3.7100, 7.1400, 4.3400, 8.7800, 4.7200, 10.3900, 4.5500, 11.8200, 3.9500, 13.1600, 3.2100, 14.1600, 2.4800, 14.3600, 2.0900, 14.4200, 1.9900, 14.6800, 2.3200, 15.3600, 2.7000, 16.2200, 3.1300, 16.6500, 3.4500, 16.3200, 3.7000, 15.5800, 3.6900, 14.4600, 3.7800, 13.1500, 3.2800, 11.6300, 3.4900, 10.3700, 3.9700, 9.1900, 4.1500, 7.8600, 4.4900, 6.9500, 4.9500, 5.7700, 5.5500, 4.9400, 6.1800, 4.2300, 6.6600, 3.4000, 7.0200, 2.3500, 7.4900, 1.3800, 8.0900, -0.5700, 8.5000, -2.5800, 8.5500, -4.8100, 8.9500, -7.0800, 9.5000, -9.2300, 9.7900, -10.2400, 10.0900, -10.5900, 10.5400, -11.0400, 11.0200, -11.4300, 11.4300, -10.9400, 11.4800, -10.1400, 11.1100, -8.3600, 10.6300, -6.4100, 9.9800, -5.1400, 9.3500, -3.7000, 8.7700, -2.8500, 8.2300, -2.2000, 7.8000, -1.7300, 7.2700, -1.2700, 6.5900, -0.7200, 6.0100, -0.1300, 5.6600, 1.4800, 4.9500, 2.9600, 4.4800, 4.5800, 4.1400, 6.1800, 4.2800, 7.9500, 4.7600, 9.0500, 4.9800, 9.8300, 5.0500, 10.9600, 4.7400, 12.0500, 3.9800, 12.9900, 3.2600, 13.2400, 2.8900, 13.1700, 2.8800, 13.1300, 3.2300, 13.2300, 3.6800, 13.4100, 4.1400, 13.4100, 4.4700, 13.8700, 4.4000, 14.0300, 4.5900, 13.4400, 4.2200, 12.6500, 3.8500, 11.6200, 4.1800, 10.0000, 4.2800, 8.8200, 4.1100, 7.9900, 4.3400, 7.1300, 4.7600, 6.4900, 5.4100, 5.8800, 6.0800, 5.3700, 6.5700, 4.3000, 7.0500, 2.8000, 7.4700, 1.1000, 8.1200, -0.7600, 8.8800, -3.0100, 9.1200, -5.5300, 9.3800, -7.4400, 9.7300, -9.1200, 10.1100, -10.5500, 10.5800, -11.4900, 11.1500, -11.5500, 11.4600, -11.5200, 11.4000, -10.8600, 11.1500, -9.7800, 10.6200, -8.3200, 10.1400, -7.0200, 9.6200, -5.8700, 9.1500, -4.5800, 8.7700, -3.5300, 8.2700, -2.6500, 7.7700, -1.7600, 7.3300, -0.9700, 6.5600, -0.0300, 6.1800, 0.8000, 5.3400, 2.2900, 4.6000, 3.3000, 4.4000, 5.0900, 4.5300, 7.3200, 4.4800, 9.3700, 4.7000, 10.6400, 4.9300, 11.5900, 4.7400, 12.6600, 4.0400, 13.7600, 3.4800, 13.7700, 3.1600, 13.4600, 2.9500, 13.5200, 2.9500, 14.0100, 3.0600, 13.9900, 3.5900, 13.6000, 3.8100, 13.4500, 3.9700, 12.8900, 4.1500, 11.8700, 4.3500, 10.9500, 4.4600, 10.1600, 4.2700, 9.4500, 4.3000, 8.6100, 4.3400, 7.7400, 4.6400, 7.1300, 4.8000, 6.2000, 5.3500, 4.8000, 6.2000, 3.8100, 6.8800, 2.8700, 7.2700, 1.5000, 7.6600, 0.2300, 8.0700, -0.8300, 8.5400, -2.0700, 9.0300, -3.0700, 9.4100, -4.0700, 9.6500, -5.0700, 10.1400, -6.5200, 10.4100, -7.7000, 10.5300, -8.4200, 10.7200, -8.9300, 10.9900, -9.2600, 11.2600, -9.3500, 11.2400, -9.2500, 11.1900, -8.9500, 10.7400, -8.3500, 10.1300, -7.6400, 9.5700, -6.8300, 9.0700, -5.7900, 8.5500, -4.8600, 8.1900, -3.8100, 7.5800, -2.5800, 7.1800, -1.0100, 6.7700, 0.5300, 6.0900, 2.2000, 5.5400, 3.4600, 4.9100, 5.2400, 4.3300, 6.2800, 4.0400, 7.2100, 4.2100, 7.9200, 4.3600, 8.9800, 4.4600, 9.3000, 4.7400, 9.4700, 4.8500, 9.9300, 4.4900, 9.5800, 4.0100, 10.5100, 3.1600, 11.6700, 2.5700, 13.4900, 2.1000, 14.8700, 2.0900, 15.9300, 2.2400, 16.3500, 2.7400, 16.0500, 3.2200, 15.2000, 3.5700, 14.1800, 3.8700, 13.1000, 3.9500, 11.7900, 4.0000, 11.0600, 3.9400, 10.8600, 3.8300, 10.3500, 4.0500, 9.5200, 4.4900, 9.1100, 4.7500, 8.8300, 5.1000, 8.2000, 5.2800, 7.3700, 5.5300, 6.3200, 5.4200, 5.2300, 5.6500, 4.0300, 6.1000, 2.4900, 6.7900, 0.8600, 7.4200, -0.6700, 7.9500, -2.2800    
    }, // Waving data
    { 
      0.3022, 2.8348, -1.2443,-0.8113,-0.3746,0.861,4.7896,1.9324,-0.2094,2.6205,3.8736, 3.5716, 5.5708, 3.7819, 7.9619, 2.4478, 8.0258, 6.9962, 6.9503, 7.1076, 7.3266, 3.2366, 8.746, 5.6972, 6.5424, 4.9279, 11.153, 8.7163, 9.0153, 9.1829, 11.6824, 9.0219, 8.6413, 11.429, 9.134, 10.8064, 13.5341, 7.9469, 9.6152, 13.7734, 6.8874, 9.1899, 8.9107, 9.3492, 8.5362, 15.3131, 10.8974, 12.4746, 12.5009, 10.8873, 12.3034, 8.7632, 13.7331, 10.6608, 9.5722, 9.6697, 11.9509, 11.1856, 14.5907, 10.7834, 6.934, 9.1403, 11.3214, 13.1939, 11.874, 13.9498, 11.4644, 6.5832, 7.5939, 9.6503, 11.1777, 11.9119, 12.5149, 8.1304, 10.5955, 9.8468, 8.2901, 7.2886, 10.7519, 10.0909, 6.2689, 7.0286, 5.9062, 8.9404, 10.2194, 8.295, 6.5706, 8.2968, 5.4831, 6.719, 2.9082, 5.8443, 5.833, 3.8302, 7.3559, 5.3837, 7.4151, 2.9448, 1.8321, 4.3503, 3.6186, 2.2791, 2.1359, 1.0393, 1.9438, -0.1453, 1.5163, -0.0773, 0.821, 1.3778, -1.6972, 2.0469, 1.9414, 1.3372, -2.1079, -2.4094, -0.8508, -2.6294, 0.5947, 0.8273, -0.5225, -2.5926, -4.85, -4.8138, -4.609, -0.6796, -0.6065, -4.6978, -5.6479, -2.0263, -6.8303, -6.4167, -4.9295, -2.36, -5.7285, -4.3078, -1.8681, -5.5446, -6.3224, -6.7426, -3.8158, -4.2639, -5.5144, -5.2643, -5.7972, -5.9568, -5.8611, -3.8017, -3.3529, -3.7868, -3.8589, -8.5289, -9.1525, -5.745, -5.9689, -7.8775, -5.7259, -6.3024, -6.8427, -3.6977, -2.4315, -7.5782, -5.8711, -8.7541, -6.6127, -4.1272, -5.4988, -2.2977, -8.9162, -8.4819, -4.5863, -6.528, -8.788, -3.7014, -5.2681, -2.3951, -5.7916, -6.7316, -4.7912, -6.8027, -5.6602, -4.9265, -2.616, -3.5331, -2.9665, -4.9145, -4.6093, -1.1234, -0.6012, -3.8264, -2.1156, -4.783, -3.1067, 0.6451, -0.6201, -2.0455, -1.4807, 3.0726, 2.3609, -1.2273, 2.8214, 4.0191, 0.2512, 3.7304, 2.7414, 1.6726, 4.6616, 5.5882, 1.2671, 5.0331, 5.465, 3.6407, 5.165, 2.6911, 7.3314, 4.0773, 6.6812, 9.8561, 6.3063, 6.6974, 10.8396, 7.5605, 10.7694, 10.6743, 8.2629, 5.8939, 6.3615, 8.5819, 8.0569, 8.1461, 8.7699, 11.0086, 10.5605, 12.2056, 10.2042, 12.7656, 8.9947, 11.4021, 12.1991, 10.5925, 11.9271, 12.458, 14.8496, 15.7519, 11.8658, 16.832, 17.2648, 14.2438, 15.5344, 10.2529, 14.4332, 18.3116, 10.8694, 13.7956, 14.0564, 18.1199, 15.779, 12.429, 10.8531, 16.7347, 13.9309, 16.1124, 15.0958, 11.9118, 16.6083, 18.7123, 16.6658, 12.7212, 13.1941, 17.7515, 15.419, 15.2262, 12.1183, 15.0128, 11.8239, 17.4863, 13.5518, 13.891, 13.9266, 17.3373, 16.3717, 10.6638, 15.7675, 12.8055, 14.9213, 13.0234, 15.5144, 16.1841, 11.5941, 11.9095, 14.7732, 13.4567, 12.3638, 11.7434, 13.1771, 12.3212
    } // Anomaly data
};

static int current_feature_set = 0;
float temperature = 0;

void setup() {
    Serial.begin(115200);

    // Unique ID must be set!
    byte mac[] = { 0xDE, 0xBE, 0xEB, 0xFE, 0xEF, 0xF0 };
    WiFi.macAddress(mac);
    device.setUniqueId(mac, sizeof(mac));

    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    while (WiFi.status() != WL_CONNECTED) {
        Serial.println("Connecting to WiFi...");
        delay(500);
    }
    Serial.println("Connected to WiFi");

    // optional device's details
    device.setName("AnamolyDetector");
    device.setSoftwareVersion("1.0.0");

    // optional properties
    class1.setCurrentState(LOW);
    class1.setName("circle");
    class1.setDeviceClass("door");
    class1.setIcon("mdi:fire");

    class2.setCurrentState(LOW);
    class2.setName("four");
    class2.setDeviceClass("door");
    class2.setIcon("mdi:fire");

    class3.setCurrentState(LOW);
    class3.setName("go");
    class3.setDeviceClass("door");
    class3.setIcon("mdi:fire");

    class4.setCurrentState(LOW);
    class4.setName("rotate");
    class4.setDeviceClass("door");
    class4.setIcon("mdi:fire");

    class5.setCurrentState(LOW);
    class5.setName("waving");
    class5.setDeviceClass("door");
    class5.setIcon("mdi:fire");   

    mqtt.begin(BROKER_ADDR, HA_USER, HA_PASS);
    // mqtt.begin(BROKER_ADDR);

}

void loop() {
    mqtt.loop();
    
    if (millis() > last_interval_ms + INTERVAL_MS) {

    current_feature_set = random(NUM_FEATURE_SETS);
    ei_printf("Using feature set %d for inference\n", current_feature_set + 1);

    signal_t features_signal;
    features_signal.total_length = FEATURE_LENGTH;
    features_signal.get_data = &raw_feature_get_data;

    ei_impulse_result_t result;
    EI_IMPULSE_ERROR res = run_classifier(&features_signal, &result, false);
    if (res != EI_IMPULSE_OK) {
        ei_printf("ERR: Failed to run classifier (%d)\n", res);
        return;
    }
    // print inference return code
    ei_printf("run_classifier returned: %d\r\n", res);
    print_inference_result(result);

    // delay(3000); // Increased delay to make it easier to read the output

    if (result.classification[0].value > 0.6) class1.setState(!class1.getCurrentState());
    else if (result.classification[1].value > 0.6) class2.setState(!class2.getCurrentState());
    else if (result.classification[2].value > 0.6) class3.setState(!class3.getCurrentState());
    else if (result.classification[3].value > 0.6) class4.setState(!class4.getCurrentState());
    else if (result.classification[4].value > 0.6) class5.setState(!class5.getCurrentState());

    temperature = result.anomaly;

    
      last_interval_ms = millis();
      sendToMongoDB();
    }
}

int raw_feature_get_data(size_t offset, size_t length, float *out_ptr) {
    memcpy(out_ptr, feature_sets[current_feature_set] + offset, length * sizeof(float));
    return 0;
}

void sendToMongoDB() {
    if (WiFi.status() == WL_CONNECTED) {
        HTTPClient http;
        http.begin(serverName);
        http.addHeader("Content-Type", "application/json");
        http.addHeader("Access-Control-Request-Headers", "*");
        http.addHeader("api-key", apiKey);

        // float temperature = 27.5; // Example sensor data
        unsigned long timestamp = millis();
        
        String jsonData = "{";
        jsonData += "\"collection\": \"temp\",";
        jsonData += "\"database\": \"temperatureDatabase\",";
        jsonData += "\"dataSource\": \"TempData\",";
        jsonData += "\"document\": {";
        jsonData += "\"timestamp\": {\"$date\": {\"$numberLong\": \"" + String(timestamp) + "\"}},";
        jsonData += "\"sensor_id\": \"sensor_06\",";
        jsonData += "\"temperature\": {\"$numberDouble\": \"" + String(temperature, 1) + "\"}";
        jsonData += "}}";

        int httpResponseCode = http.POST(jsonData);
        if (httpResponseCode > 0) {
            Serial.println(httpResponseCode);
            Serial.println(http.getString());
        } else {
            Serial.print("Error on sending POST: ");
            Serial.println(httpResponseCode);
        }
        http.end();
    } else {
        Serial.println("WiFi Disconnected");
    }
}

void ei_printf(const char *format, ...) {
    char print_buf[1024];
    va_list args;
    va_start(args, format);
    vsnprintf(print_buf, sizeof(print_buf), format, args);
    va_end(args);
    Serial.write(print_buf);
}

void print_inference_result(ei_impulse_result_t result) {
    // Print how long it took to perform inference
    ei_printf("Timing: DSP %d ms, inference %d ms, anomaly %d ms\r\n",
            result.timing.dsp,
            result.timing.classification,
            result.timing.anomaly);

    // Print the prediction results (object detection)
#if EI_CLASSIFIER_OBJECT_DETECTION == 1
    return

    // Print the prediction results (classification)
#else
    ei_printf("Predictions for feature set %d:\r\n", current_feature_set + 1);
    for (uint16_t i = 0; i < EI_CLASSIFIER_LABEL_COUNT; i++) {
        ei_printf("  %s: ", ei_classifier_inferencing_categories[i]);
        ei_printf("%.5f\r\n", result.classification[i].value);
    }
#endif

    // Print anomaly result (if it exists)
#if EI_CLASSIFIER_HAS_ANOMALY
    ei_printf("Anomaly prediction: %.3f\r\n", result.anomaly);
#endif

}
